name: Deploy to Cloudflare Pages

on:
  workflow_dispatch:

jobs:
  lint:
    name: Lint Code
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

  unit-test:
    name: Unit Tests
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run unit tests with coverage
        run: npm run test:unit:coverage

      - name: Upload unit test coverage
        uses: actions/upload-artifact@v4
        with:
          name: coverage-unit
          path: coverage/
          retention-days: 7

  build:
    name: Build for Cloudflare
    runs-on: ubuntu-latest
    needs: unit-test
    env:
      CF_PAGES: true
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: dist
          path: dist/
          retention-days: 1

  deploy:
    name: Deploy to Cloudflare Pages
    runs-on: ubuntu-latest
    needs: build
    permissions:
      contents: read
      deployments: write
    env:
      SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
      SUPABASE_KEY: ${{ secrets.SUPABASE_KEY }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: dist
          path: dist/

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "npm"

      - name: Install Wrangler
        run: npm install -g wrangler

      - name: Verify secrets are available
        run: |
          if [ -z "$CLOUDFLARE_API_TOKEN" ]; then
            echo "‚ùå CLOUDFLARE_API_TOKEN is not set"
            exit 1
          else
            echo "‚úÖ CLOUDFLARE_API_TOKEN is set (length: ${#CLOUDFLARE_API_TOKEN})"
          fi
          if [ -z "$CLOUDFLARE_ACCOUNT_ID" ]; then
            echo "‚ùå CLOUDFLARE_ACCOUNT_ID is not set"
            exit 1
          else
            echo "‚úÖ CLOUDFLARE_ACCOUNT_ID is set"
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy to Cloudflare Pages
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
        run: wrangler pages deploy dist --project-name=10x-cards

  deployment-status:
    name: Deployment Status
    runs-on: ubuntu-latest
    needs: [lint, unit-test, build, deploy]
    if: always()
    permissions:
      contents: read
      actions: read
      id-token: write
    steps:
      - name: Download unit test coverage
        uses: actions/download-artifact@v4
        with:
          name: coverage-unit
          path: coverage/
        continue-on-error: true

      - name: Generate deployment summary
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const path = require('path');

            // Get job statuses
            const jobs = {
              lint: '${{ needs.lint.result }}',
              unitTest: '${{ needs.unit-test.result }}',
              build: '${{ needs.build.result }}',
              deploy: '${{ needs.deploy.result }}',
            };

            // Helper to create status emoji
            const getStatusEmoji = (status) => {
              switch(status) {
                case 'success': return '‚úÖ';
                case 'failure': return '‚ùå';
                case 'cancelled': return '‚ö†Ô∏è';
                case 'skipped': return '‚è≠Ô∏è';
                default: return '‚ùì';
              }
            };

            // Build summary body
            let summaryBody = '## üöÄ Deployment to Cloudflare Pages\n\n';
            summaryBody += '### Job Status\n\n';
            summaryBody += `| Job | Status |\n`;
            summaryBody += `|-----|--------|\n`;
            summaryBody += `| Lint | ${getStatusEmoji(jobs.lint)} ${jobs.lint} |\n`;
            summaryBody += `| Unit Tests | ${getStatusEmoji(jobs.unitTest)} ${jobs.unitTest} |\n`;
            summaryBody += `| Build | ${getStatusEmoji(jobs.build)} ${jobs.build} |\n`;
            summaryBody += `| Deploy | ${getStatusEmoji(jobs.deploy)} ${jobs.deploy} |\n`;
            summaryBody += '\n';

            // Overall status
            const allSuccess = Object.values(jobs).every(status => status === 'success');
            if (allSuccess) {
              summaryBody += '### ‚úÖ Deployment successful!\n\n';
              summaryBody += `Your application has been deployed to Cloudflare Pages.\n`;
            } else {
              summaryBody += '### ‚ö†Ô∏è Deployment failed\n\n';
              summaryBody += 'Please review the failed jobs and fix any issues.\n';
            }

            // Try to read coverage summary
            try {
              const coveragePath = path.join('coverage', 'coverage-summary.json');
              if (fs.existsSync(coveragePath)) {
                const coverageData = JSON.parse(fs.readFileSync(coveragePath, 'utf8'));
                const total = coverageData.total;
                
                summaryBody += '\n### üìä Unit Test Coverage\n\n';
                summaryBody += `| Metric | Coverage |\n`;
                summaryBody += `|--------|----------|\n`;
                summaryBody += `| Lines | ${total.lines.pct}% |\n`;
                summaryBody += `| Statements | ${total.statements.pct}% |\n`;
                summaryBody += `| Functions | ${total.functions.pct}% |\n`;
                summaryBody += `| Branches | ${total.branches.pct}% |\n`;
              }
            } catch (error) {
              console.log('Coverage summary not available');
            }

            summaryBody += '\n---\n';
            summaryBody += `*Workflow run: [#${context.runNumber}](${context.payload.repository.html_url}/actions/runs/${context.runId})*\n`;

            // Write to job summary
            await core.summary
              .addRaw(summaryBody)
              .write();
