# ğŸ”„ Diagram PrzepÅ‚ywu - Logowanie UÅ¼ytkownika

## PrzepÅ‚yw Danych (Data Flow)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         PROCES LOGOWANIA                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Browser    â”‚
â”‚ (User)       â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 1. WejÅ›cie na /auth/login
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Astro Middleware                    â”‚
â”‚  src/middleware/index.ts             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ“ createSupabaseServerInstance()   â”‚
â”‚  âœ“ Sprawdza cookies (getAll)         â”‚
â”‚  âœ“ auth.getUser()                    â”‚
â”‚  âœ“ JeÅ›li user â†’ Astro.locals.user    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 2. Przekazanie do strony
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  login.astro                         â”‚
â”‚  src/pages/auth/login.astro          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  if (Astro.locals.user) {            â”‚
â”‚    return Astro.redirect('/generate')â”‚
â”‚  }                                   â”‚
â”‚  â†’ Renderuj LoginForm                â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 3. SSR â†’ HTML wysÅ‚any do klienta
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LoginForm.tsx (React)               â”‚
â”‚  src/components/auth/LoginForm.tsx   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  âœ“ Stan: email, password, error      â”‚
â”‚  âœ“ Walidacja client-side             â”‚
â”‚  âœ“ handleSubmit()                    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 4. User wypeÅ‚nia formularz i klika "Zaloguj siÄ™"
       â”‚
       â”‚ 5. fetch POST /api/auth/login
       â”‚    { email, password }
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Login API Endpoint                                      â”‚
â”‚  src/pages/api/auth/login.ts                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  1. Parsowanie JSON body                                 â”‚
â”‚  2. Walidacja Zod schema                                 â”‚
â”‚  3. createSupabaseServerInstance()                       â”‚
â”‚  4. supabase.auth.signInWithPassword()  â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚                                                â”‚          â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚     â–¼                                                     â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚   Supabase Auth                â”‚                      â”‚
â”‚  â”‚   (External Service)           â”‚                      â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                      â”‚
â”‚  â”‚ âœ“ Weryfikacja email/password   â”‚                      â”‚
â”‚  â”‚ âœ“ Generowanie JWT tokens       â”‚                      â”‚
â”‚  â”‚ âœ“ Utworzenie sesji             â”‚                      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚           â”‚ Return: session + user                       â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”˜                                              â”‚
â”‚     â–¼                                                     â”‚
â”‚  5. SSR automatycznie ustawia cookies (setAll):          â”‚
â”‚     - sb-access-token (httpOnly)                         â”‚
â”‚     - sb-refresh-token (httpOnly)                        â”‚
â”‚                                                           â”‚
â”‚  6. Response body:                                       â”‚
â”‚     {                                                     â”‚
â”‚       accessToken, refreshToken, expiresIn, user         â”‚
â”‚     }                                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚ 7. HTTP 200 OK
            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LoginForm.tsx                       â”‚
â”‚  (handleSubmit callback)             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  if (response.ok) {                  â”‚
â”‚    âœ“ Zapisz tokens w storage:       â”‚
â”‚      - localStorage (rememberMe)     â”‚
â”‚      - sessionStorage (default)      â”‚
â”‚    âœ“ window.location.href='/generate'â”‚
â”‚  }                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚ 8. Client-side redirect
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Browser â†’ /generate                 â”‚
â”‚                                      â”‚
â”‚  âœ“ Cookies wysÅ‚ane w request         â”‚
â”‚  âœ“ Middleware sprawdza sesjÄ™         â”‚
â”‚  âœ“ Astro.locals.user ustawiony       â”‚
â”‚  âœ“ Renderuje chronionÄ… stronÄ™        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## PrzepÅ‚yw Sprawdzania Sesji (Middleware)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         KAÅ»DE Å»Ä„DANIE DO SERWERA ASTRO                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Request    â”‚ (z cookies)
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Middleware                                     â”‚
â”‚  src/middleware/index.ts                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                 â”‚
â”‚  1. context.locals.supabase = serviceClient     â”‚
â”‚     (dla operacji na danych)                    â”‚
â”‚                                                 â”‚
â”‚  2. supabase = createSupabaseServerInstance()   â”‚
â”‚     â”œâ”€ cookies.getAll()                         â”‚
â”‚     â”‚  â””â”€> parseCookieHeader()                  â”‚
â”‚     â”‚      â””â”€> [{name, value}, ...]             â”‚
â”‚     â””â”€ zwraca auth client                       â”‚
â”‚                                                 â”‚
â”‚  3. { data: { user } } = await                  â”‚
â”‚     supabase.auth.getUser()                     â”‚
â”‚     â”‚                                           â”‚
â”‚     â”œâ”€ Sprawdza sb-access-token w cookies       â”‚
â”‚     â”œâ”€ Weryfikuje JWT signature                 â”‚
â”‚     â””â”€ Dekoduje token â†’ user object             â”‚
â”‚                                                 â”‚
â”‚  4. if (user) {                                 â”‚
â”‚       context.locals.user = {                   â”‚
â”‚         id: user.id,                            â”‚
â”‚         email: user.email                       â”‚
â”‚       }                                         â”‚
â”‚     }                                           â”‚
â”‚                                                 â”‚
â”‚  5. return next()                               â”‚
â”‚     â””â”€> Przekazanie do route handler           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Astro Page              â”‚
â”‚  (np. generate.astro)    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  const user =            â”‚
â”‚    Astro.locals.user     â”‚
â”‚                          â”‚
â”‚  if (!user) {            â”‚
â”‚    return Astro.redirect â”‚
â”‚           ('/auth/login')â”‚
â”‚  }                       â”‚
â”‚                          â”‚
â”‚  // Renderuj stronÄ™      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Mechanizm Cookies (SSR Auth)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          SUPABASE SSR COOKIE MANAGEMENT                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  createSupabaseServerInstance   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                 â”‚
â”‚  createServerClient(            â”‚
â”‚    supabaseUrl,                 â”‚
â”‚    supabaseAnonKey,             â”‚
â”‚    {                            â”‚
â”‚      cookieOptions: {           â”‚
â”‚        path: '/',               â”‚
â”‚        secure: true,            â”‚
â”‚        httpOnly: true,          â”‚ â† XSS Protection
â”‚        sameSite: 'lax',         â”‚ â† CSRF Protection
â”‚      },                         â”‚
â”‚      cookies: {                 â”‚
â”‚        getAll() {               â”‚ â† READ cookies
â”‚          return                 â”‚
â”‚            parseCookieHeader(   â”‚
â”‚              headers.get(       â”‚
â”‚                'Cookie'         â”‚
â”‚              )                  â”‚
â”‚            )                    â”‚
â”‚        },                       â”‚
â”‚        setAll(cookiesToSet) {   â”‚ â† WRITE cookies
â”‚          cookiesToSet.forEach(  â”‚
â”‚            ({ name, value,      â”‚
â”‚               options }) => {   â”‚
â”‚              cookies.set(       â”‚
â”‚                name,            â”‚
â”‚                value,           â”‚
â”‚                options          â”‚
â”‚              )                  â”‚
â”‚            }                    â”‚
â”‚          )                      â”‚
â”‚        }                        â”‚
â”‚      }                          â”‚
â”‚    }                            â”‚
â”‚  )                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

     â”‚ Po signInWithPassword()
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Supabase SSR automatycznie:    â”‚
â”‚                                 â”‚
â”‚  setAll([                       â”‚
â”‚    {                            â”‚
â”‚      name: 'sb-access-token',   â”‚
â”‚      value: 'eyJhbG...',        â”‚ â† JWT Token (1h)
â”‚      options: {                 â”‚
â”‚        httpOnly: true,          â”‚
â”‚        secure: true,            â”‚
â”‚        sameSite: 'lax',         â”‚
â”‚        maxAge: 3600             â”‚
â”‚      }                          â”‚
â”‚    },                           â”‚
â”‚    {                            â”‚
â”‚      name: 'sb-refresh-token',  â”‚
â”‚      value: 'abc123...',        â”‚ â† Refresh (7d)
â”‚      options: {                 â”‚
â”‚        httpOnly: true,          â”‚
â”‚        secure: true,            â”‚
â”‚        sameSite: 'lax',         â”‚
â”‚        maxAge: 604800           â”‚
â”‚      }                          â”‚
â”‚    }                            â”‚
â”‚  ])                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

     â”‚ KaÅ¼dy kolejny request
     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Browser automatycznie wysyÅ‚a:  â”‚
â”‚                                 â”‚
â”‚  Cookie:                        â”‚
â”‚    sb-access-token=eyJ...;      â”‚
â”‚    sb-refresh-token=abc...      â”‚
â”‚                                 â”‚
â”‚  â†’ Middleware â†’ getAll() â†’      â”‚
â”‚    parseCookieHeader() â†’        â”‚
â”‚    auth.getUser() â†’             â”‚
â”‚    Astro.locals.user âœ“          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Hybrid Storage Strategy

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              GDZIE SÄ„ PRZECHOWYWANE TOKENY?            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Server-side     â”‚         â”‚  Client-side             â”‚
â”‚  (Automatic)     â”‚         â”‚  (Manual)                â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                  â”‚         â”‚                          â”‚
â”‚  Cookies:        â”‚         â”‚  If rememberMe = true:   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ httpOnly âœ“  â”‚ â”‚         â”‚  â”‚ localStorage        â”‚ â”‚
â”‚  â”‚ secure âœ“    â”‚ â”‚         â”‚  â”‚ â”œâ”€ access-token     â”‚ â”‚
â”‚  â”‚ sameSite âœ“  â”‚ â”‚         â”‚  â”‚ â””â”€ refresh-token    â”‚ â”‚
â”‚  â”‚             â”‚ â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  â”‚ sb-access-  â”‚ â”‚         â”‚                          â”‚
â”‚  â”‚   token     â”‚ â”‚         â”‚  If rememberMe = false:  â”‚
â”‚  â”‚             â”‚ â”‚         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ sb-refresh- â”‚ â”‚         â”‚  â”‚ sessionStorage      â”‚ â”‚
â”‚  â”‚   token     â”‚ â”‚         â”‚  â”‚ â”œâ”€ access-token     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚         â”‚  â”‚ â””â”€ refresh-token    â”‚ â”‚
â”‚                  â”‚         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚  UÅ¼ywane przez:  â”‚         â”‚                          â”‚
â”‚  â€¢ Middleware    â”‚         â”‚  UÅ¼ywane przez:          â”‚
â”‚  â€¢ SSR Pages     â”‚         â”‚  â€¢ React Components      â”‚
â”‚  â€¢ API Routes    â”‚         â”‚  â€¢ Client-side requests  â”‚
â”‚                  â”‚         â”‚  â€¢ fetch() with headers  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

     â”‚                              â”‚
     â”‚                              â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                    â”‚
                    â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚   WHY HYBRID?                â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                              â”‚
     â”‚ 1. Cookies (httpOnly) =      â”‚
     â”‚    bezpieczne dla SSR        â”‚
     â”‚    (nie moÅ¼na ukraÅ›Ä‡ przez   â”‚
     â”‚     XSS attack)              â”‚
     â”‚                              â”‚
     â”‚ 2. localStorage =            â”‚
     â”‚    wygodne dla React         â”‚
     â”‚    components ktÃ³re robiÄ…    â”‚
     â”‚    API requests              â”‚
     â”‚                              â”‚
     â”‚ 3. Redundancja =             â”‚
     â”‚    jeÅ›li jeden failuje,      â”‚
     â”‚    drugi dziaÅ‚a              â”‚
     â”‚                              â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Error Handling Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚       OBSÅUGA BÅÄ˜DÃ“W                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

POST /api/auth/login
â”‚
â”œâ”€ Parsing JSON
â”‚  â””â”€ FAIL â†’ 400 Bad Request
â”‚            "Invalid JSON"
â”‚
â”œâ”€ Zod Validation
â”‚  â””â”€ FAIL â†’ 400 Bad Request
â”‚            { details: [...] }
â”‚
â”œâ”€ Supabase signInWithPassword()
â”‚  â”‚
â”‚  â”œâ”€ NieprawidÅ‚owe dane
â”‚  â”‚  â””â”€ 401 Unauthorized
â”‚  â”‚     "Invalid email or password"
â”‚  â”‚
â”‚  â”œâ”€ User niezweryfikowany
â”‚  â”‚  â””â”€ 401 Unauthorized
â”‚  â”‚     "Email not verified"
â”‚  â”‚
â”‚  â”œâ”€ Rate limit exceeded
â”‚  â”‚  â””â”€ 429 Too Many Requests
â”‚  â”‚     "Too many login attempts"
â”‚  â”‚
â”‚  â””â”€ Supabase down/error
â”‚     â””â”€ 500 Internal Server Error
â”‚        "Authentication failed"
â”‚
â””â”€ Unexpected error (catch)
   â””â”€ 500 Internal Server Error
      "An unexpected error occurred"

   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LoginForm.tsx                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                        â”‚
â”‚  if (!response.ok) {                   â”‚
â”‚    setState({                          â”‚
â”‚      error: data.message               â”‚
â”‚    })                                  â”‚
â”‚    â†’ ErrorNotification displays        â”‚
â”‚  }                                     â”‚
â”‚                                        â”‚
â”‚  catch (error) {                       â”‚
â”‚    setState({                          â”‚
â”‚      error: "Nie udaÅ‚o siÄ™ poÅ‚Ä…czyÄ‡    â”‚
â”‚              z serwerem"               â”‚
â”‚    })                                  â”‚
â”‚  }                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Security Layers

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              WARSTWY BEZPIECZEÅƒSTWA                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Layer 1: Client-side Validation
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  LoginForm.tsx               â”‚
â”‚  âœ“ Email format (regex)      â”‚
â”‚  âœ“ Password not empty        â”‚
â”‚  âœ“ Disable button if invalid â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
Layer 2: Server-side Validation
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  /api/auth/login.ts          â”‚
â”‚  âœ“ Zod schema validation     â”‚
â”‚  âœ“ Type safety (TypeScript)  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
Layer 3: Supabase Auth
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Supabase Service            â”‚
â”‚  âœ“ Password hashing (bcrypt) â”‚
â”‚  âœ“ JWT signing/verification  â”‚
â”‚  âœ“ Rate limiting             â”‚
â”‚  âœ“ Session management        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
Layer 4: Cookie Security
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Browser Cookies             â”‚
â”‚  âœ“ httpOnly (no JS access)   â”‚
â”‚  âœ“ secure (HTTPS only)       â”‚
â”‚  âœ“ sameSite: lax (CSRF)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â–¼
Layer 5: Middleware Verification
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  src/middleware/index.ts     â”‚
â”‚  âœ“ JWT verification on every â”‚
â”‚    request                   â”‚
â”‚  âœ“ User extraction from tokenâ”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Token Lifecycle

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              CYKL Å»YCIA TOKENU                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

T=0: Login
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ POST /api/auth/login   â”‚
â”‚ â†’ Supabase generuje:   â”‚
â”‚   â€¢ Access Token (1h)  â”‚
â”‚   â€¢ Refresh Token (7d) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

T=0 - T=59min: Active Session
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Every request:         â”‚
â”‚ â†’ Access Token valid   â”‚
â”‚ â†’ Middleware extracts  â”‚
â”‚   user from token      â”‚
â”‚ â†’ Astro.locals.user âœ“  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

T=60min: Token Expired
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Request fails:         â”‚
â”‚ â†’ Access Token invalid â”‚
â”‚ â†’ auth.getUser() fails â”‚
â”‚ â†’ Astro.locals.user = undefined
â”‚ â†’ Redirect to /login   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Future: Auto Refresh (TODO)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ useAuth hook:          â”‚
â”‚ â†’ Sprawdza exp w JWT   â”‚
â”‚ â†’ Przed wygaÅ›niÄ™ciem   â”‚
â”‚   wywoÅ‚uje             â”‚
â”‚   refreshSession()     â”‚
â”‚ â†’ Nowy Access Token    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

**Koniec diagramÃ³w**

Dla lepszego zrozumienia implementacji, przejrzyj rÃ³wnieÅ¼:

- `.ai/auth-login-implementation-summary.md` - szczegÃ³Å‚owa dokumentacja
- `.ai/auth-login-quick-start.md` - instrukcja testowania
